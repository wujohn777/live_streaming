const FormAutoFill = new Vue({
  el: '#app',
  data: {

    // Google Apps Script 部署為網路應用程式後的 URL
    gas: 'https://script.google.com/macros/s/AKfycbywEcQWgE3iazaY0kMSANZLNU2LYhZYsyqYu28qCj55PqUszAI/exec',

    id: '', // 帳號
    password: '', // 密碼
    pass: false, // 檢核通過 
    view_date, 

    // 避免重複 POST，存資料用的
    persons: {},

    // 頁面上吐資料的 data
    person: {},

    // Google Form 的 action URL
    formAction: 'https://docs.google.com/forms/u/0/d/e/1FAIpQLSc7YmUz1Axd2ipaLxoxAkbI2MHIZUpCHY-IN7yNtvK-nDr9Jw/formResponse',
    
    // Google Form 各個 input 的 name
    input: {
      zone: 'entry.1537494240',
      cell: 'entry.1013553506',
      leader: 'entry.1480730956',
      name: 'entry.513243022',
      kind: 'entry.1620297305',
      view_date: 'entry.1727888953',
      reason: 'entry.262096140',
      memo: 'entry.289920083'
    },

    // loading 效果要不要顯示
    loading: false
  },
  methods: {
    // 若帳號和密碼輸入了,則查詢相關資訊
    getInfo() {
    	if (this.id.trim() != "" && this.password.trim() != "") {
	        // this.persons 裡沒這筆資料，才 POST
	        if (this.persons[this.id] === undefined) {
	           this.loading = true;
	           let uri = this.gas + '?id=' + this.id + '&password=' + this.password ;
	           fetch(uri, {
	             method: 'POST'
	           }).then(res => res.json())
	             .then(res => {
	               if (Object.keys(res).length === 0) {
	               	  // 清空輸入的帳密
	               	  this.id = ""
	               	  this.password = ""
	               	  // 提示訊息
	               	  alert('請確認輸入的帳號或密碼是正確的!!!');
	               } else {
		              this.persons[this.id] = res; // 把這次查詢的 id 結果存下來
		              this.person = res;
		              this.pass = true;
		           }
	               this.loading = false;
	             })
	        }
	        // this.persons 裡有資料就吐資料
	        else {
	          this.person = this.persons[this.id];
	        }
    	}
    },    
    // 送出表單
    submit() {
      // 再一次判斷是不是可以送出資料
      // alert(document.getElementById("view_date").value);
      // alert(this.person.view_date);
      if (this.pass) {
	      this.person.view_date = document.getElementById("view_date").value;
         let params = `${this.input.leader}=${this.person.leader}&${this.input.zone}=${this.person.zone}&${this.input.cell}=${this.person.cell}&${this.input.name}=${this.person.name}&${this.input.kind}=${this.person.kind}&${this.input.view_date}=${this.person.view_date}&${this.input.reason}=${this.person.reason}&${this.input.memo}=${this.person.memo}`;
         fetch(this.formAction + '?' + params, {
           method: 'POST'
         }).catch(err => {
            alert('提交成功。');
            this.id = '';
            this.password = '';
            document.getElementById("view_date").value = '';
            this.person = {};
            this.pass = false;
          })
      }
    }
  }
})